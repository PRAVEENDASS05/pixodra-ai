<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pixodra.ai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    .chat-container {
      height: 420px;
      overflow-y: auto;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-gray-900 via-black to-gray-900 min-h-screen flex items-center justify-center text-white">

  <div class="max-w-2xl w-full h-[90vh] bg-black/70 backdrop-blur-xl rounded-3xl shadow-2xl flex flex-col">

    <!-- HEADER -->
    <div class="p-4 border-b border-gray-700 text-center">
      <h1 class="text-2xl font-bold">PIXODRA<span class="text-blue-400">.AI</span></h1>
      <p class="text-xs text-gray-400">Your friendly AI study companion</p>
    </div>

    <!-- CHAT -->
    <div id="chat" class="chat-container flex-1 p-4 space-y-4"></div>

    <!-- CONTROLS -->
    <div class="p-3 border-t border-gray-700 space-y-2">

      <!-- LANGUAGE -->
      <div class="flex gap-2">
        <button onclick="setLanguage('english')" class="btn">English</button>
        <button onclick="setLanguage('tamil')" class="btn">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
        <button onclick="setLanguage('tanglish')" class="btn">Tanglish</button>
      </div>

      <!-- TOOLS -->
      <div class="flex gap-2">
        <button onclick="useTool('summarize')" class="tool bg-green-600">Summarize</button>
        <button onclick="useTool('notes')" class="tool bg-orange-600">Short Notes</button>
        <button onclick="makePDF()" class="tool bg-purple-600">Make PDF</button>
      </div>

      <!-- INPUT -->
      <div class="flex gap-2">
        <textarea
          id="userInput"
          rows="1"
          placeholder="Message Pixodra..."
          class="flex-1 p-3 rounded-xl bg-gray-900 border border-gray-700 resize-none"
        ></textarea>
        <button onclick="askPixodra()" class="send-btn">Send</button>
      </div>
    </div>
  </div>

<script>
  const { jsPDF } = window.jspdf;

  /* ---------- Anonymous User ID ---------- */
  let userId = localStorage.getItem("pixodra_user_id");
  if (!userId) {
    userId = "user_" + Math.random().toString(36).substring(2, 10);
    localStorage.setItem("pixodra_user_id", userId);
  }

  let selectedLanguage = "english";
  let selectedTool = "";
  let lastAnswer = "";

  function setLanguage(lang) {
    selectedLanguage = lang;
  }

  function useTool(tool) {
    selectedTool = tool;
  }

  function addMessage(text, sender = "ai") {
    const chat = document.getElementById("chat");
    const bubble = document.createElement("div");

    bubble.className =
      sender === "user"
        ? "ml-auto max-w-[80%] bg-blue-600 p-3 rounded-2xl rounded-br-sm text-sm"
        : "mr-auto max-w-[80%] bg-gray-800 p-3 rounded-2xl rounded-bl-sm text-sm";

    bubble.innerText = text;
    chat.appendChild(bubble);
    chat.scrollTop = chat.scrollHeight;
  }

  async function askPixodra() {
    const inputBox = document.getElementById("userInput");
    const input = inputBox.value.trim();
    inputBox.value = "";

    if (!input) return;

    addMessage(input, "user");

    // Greeting shortcut
    if (["hi", "hello", "hey"].includes(input.toLowerCase())) {
      addMessage("Vanakkam üòä Ungaluku enna vendum?");
      return;
    }

    let lang =
      selectedLanguage === "tamil"
        ? "Reply only in Tamil."
        : selectedLanguage === "tanglish"
        ? "Reply in Tanglish (Tamil + English mixed)."
        : "Reply in simple English.";

    let tool =
      selectedTool === "summarize"
        ? "Summarize clearly in bullet points."
        : selectedTool === "notes"
        ? "Write short exam-oriented notes."
        : "";

    addMessage("Pixodra is thinking...", "ai");

    try {
      const res = await fetch("/api/ask", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: lang + " " + tool + " " + input,
          userId: userId,
          language: selectedLanguage,
          tool: selectedTool,
          timestamp: new Date().toISOString()
        })
      });

      const data = await res.json();
      document.getElementById("chat").lastChild.remove();
      addMessage(data.reply);
      lastAnswer = data.reply;
      selectedTool = "";
    } catch {
      document.getElementById("chat").lastChild.remove();
      addMessage("Something went wrong üòï");
    }
  }

  function makePDF() {
    if (!lastAnswer) return alert("No response to convert!");

    const pdf = new jsPDF();
    const lines = pdf.splitTextToSize(lastAnswer, 180);
    pdf.text(lines, 10, 15);
    pdf.save("Pixodra_Response.pdf");
  }
</script>

<style>
  .btn {
    flex: 1;
    background: #374151;
    padding: 0.4rem;
    border-radius: 0.6rem;
    font-size: 0.75rem;
  }
  .tool {
    flex: 1;
    padding: 0.4rem;
    border-radius: 0.6rem;
    font-size: 0.75rem;
  }
  .send-btn {
    background: #2563eb;
    padding: 0.6rem 1rem;
    border-radius: 0.8rem;
    font-weight: bold;
  }
</style>

</body>
</html>
