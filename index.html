<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pixodra.ai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Tamil Unicode Font -->
  <script src="https://cdn.jsdelivr.net/gh/parsavar/jspdf-fonts@master/fonts/NotoSansTamil-Regular.js"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.4s ease-out; }

    .typing span {
      animation: blink 1.4s infinite both;
    }
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes blink {
      0%{opacity:.2} 20%{opacity:1} 100%{opacity:.2}
    }

    .lang-btn {
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      transition: .2s;
      font-size: 14px;
    }
    .lang-btn:hover { background: rgba(255,255,255,0.15); }

    .active-lang {
      background: rgba(99,102,241,0.35);
      color: #e0e7ff;
      font-weight: 600;
      box-shadow: 0 0 0 2px rgba(99,102,241,0.4);
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-gray-900 to-black min-h-screen text-white">

<div class="max-w-4xl mx-auto p-4">

  <!-- HEADER -->
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold">PIXODRA.AI</h1>
    <button onclick="window.location.href='/symposium'"
      class="px-4 py-2 rounded-xl bg-indigo-600/20 text-indigo-400 hover:bg-indigo-600/30">
      ðŸŽ“ Symposium Finder
    </button>
  </div>

  <!-- LANGUAGE -->
  <div class="flex gap-3 mb-4">
    <button id="english" class="lang-btn active-lang" onclick="setLang('english')">English</button>
    <button id="tamil" class="lang-btn" onclick="setLang('tamil')">Tamil</button>
    <button id="tanglish" class="lang-btn" onclick="setLang('tanglish')">Tanglish</button>
  </div>

  <!-- CHAT -->
  <div class="bg-[#0f172a]/90 rounded-2xl shadow-xl p-4">
    <div id="chat" class="space-y-3 mb-4 max-h-[55vh] overflow-y-auto"></div>

    <textarea id="userInput" rows="3"
      placeholder="Ask Pixodra anythingâ€¦"
      class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700 focus:outline-none"></textarea>

    <div class="flex gap-3 mt-3">
      <button onclick="askPixodra()"
        class="flex-1 bg-white text-black py-2 rounded-xl font-semibold">
        Send
      </button>
      <button onclick="makePDF()"
        class="flex-1 bg-white/15 py-2 rounded-xl">
        Make PDF
      </button>
    </div>
  </div>

  <p class="text-xs text-gray-500 text-center mt-4">
    Built by Pixodra Technologies
  </p>
</div>

<script>
  const { jsPDF } = window.jspdf;

  let selectedLang = "english";
  let conversation = [];
  let lastUserQuestion = "";

  function setLang(lang){
    selectedLang = lang;
    document.querySelectorAll(".lang-btn").forEach(b=>b.classList.remove("active-lang"));
    document.getElementById(lang).classList.add("active-lang");

    const p = {
      tamil: "Ungal kelviyai inge type pannungaâ€¦",
      tanglish: "Ungal question-ah inga type pannungaâ€¦",
      english: "Ask Pixodra anythingâ€¦"
    };
    userInput.placeholder = p[lang];
  }

  async function askPixodra(){
    const input = userInput.value.trim();
    if(!input) return;

    lastUserQuestion = input;

    chat.innerHTML += `
      <div class="text-right fade-in">
        <div class="inline-block bg-indigo-600/20 px-3 py-2 rounded-xl">${input}</div>
      </div>`;
    userInput.value="";
    chat.scrollTop = chat.scrollHeight;

    if(input.toLowerCase()==="hi"){
      addBot("Vanakkam ðŸ˜Š Ungaluku enna vendum?");
      return;
    }

    const typing = document.createElement("div");
    typing.innerHTML = `
      <div class="inline-block bg-gray-700/40 px-3 py-2 rounded-xl typing">
        Pixodra typing<span>.</span><span>.</span><span>.</span>
      </div>`;
    chat.appendChild(typing);
    chat.scrollTop = chat.scrollHeight;

    try{
      const res = await fetch("/api/ask",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ message:`[${selectedLang}] ${input}` })
      });
      const data = await res.json();
      typing.remove();
      addBot(data.reply);
      conversation.push(data.reply);
    }catch{
      typing.remove();
      addBot("Something went wrong. Try again.");
    }
  }

  function addBot(text){
    chat.innerHTML += `
      <div class="text-left fade-in">
        <div class="inline-block bg-gray-700/50 px-3 py-2 rounded-xl">${text}</div>
      </div>`;
    chat.scrollTop = chat.scrollHeight;
  }

  function makePDF(){
    if(!conversation.length) return alert("No content to export");

    const doc = new jsPDF();
    const marginLeft = 15;
    const marginRight = 180;
    const top = 20;
    const bottom = 20;
    const pageH = doc.internal.pageSize.height;
    let y = top + 10;

    // FONT
    if(selectedLang==="tamil"){
      doc.addFileToVFS("Tamil.ttf", NotoSansTamilRegular);
      doc.addFont("Tamil.ttf","Tamil","normal");
      doc.setFont("Tamil");
    }else{
      doc.setFont("Helvetica");
    }

    const date = new Date().toLocaleString();

    doc.setFontSize(12);
    doc.setFont(undefined,"bold");
    doc.text(
      `Question: ${lastUserQuestion} | Date: ${date} | Language: ${selectedLang.toUpperCase()}`,
      marginLeft,
      top
    );

    doc.setFont(undefined,"normal");
    doc.setFontSize(11);

    conversation.forEach(msg=>{
      const lines = doc.splitTextToSize(msg, marginRight);
      lines.forEach(line=>{
        if(y > pageH - bottom){
          footer(doc);
          doc.addPage();
          y = top;
        }
        doc.text(line, marginLeft, y);
        y+=6;
      });
      y+=4;
    });

    footer(doc);
    doc.save("pixodra-response.pdf");
  }

  function footer(doc){
    const h = doc.internal.pageSize.height;
    doc.setFont("Courier","italic");
    doc.setFontSize(9);
    doc.setTextColor(150);
    doc.text("Thanks for using Pixodra.ai", 15, h-10);
    doc.setTextColor(0);
  }
</script>

</body>
</html>
