<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pixodra.ai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tamil-safe font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;600&display=swap" rel="stylesheet">

  <!-- html2pdf bundle (includes jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.3s ease-out; }

    .typing span {
      animation: blink 1.4s infinite both;
    }
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes blink {
      0%{opacity:.2} 20%{opacity:1} 100%{opacity:.2}
    }

    .lang-btn {
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      transition: .2s;
      font-size: 14px;
    }
    .active-lang {
      background: rgba(99,102,241,0.35);
      color: #e0e7ff;
      font-weight: 600;
      box-shadow: 0 0 0 2px rgba(99,102,241,0.4);
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-gray-900 to-black min-h-screen text-white">

<div class="max-w-4xl mx-auto p-4">

  <!-- HEADER -->
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold">PIXODRA.AI</h1>
    <button onclick="window.location.href='/symposium'"
      class="px-4 py-2 rounded-xl bg-indigo-600/20 text-indigo-400 hover:bg-indigo-600/30">
      ðŸŽ“ Symposium Finder
    </button>
  </div>

  <!-- LANGUAGE -->
  <div class="flex gap-3 mb-4">
    <button id="english" class="lang-btn active-lang" onclick="setLang('english')">English</button>
    <button id="tamil" class="lang-btn" onclick="setLang('tamil')">Tamil</button>
    <button id="tanglish" class="lang-btn" onclick="setLang('tanglish')">Tanglish</button>
  </div>

  <!-- CHAT -->
  <div class="bg-[#0f172a]/90 rounded-2xl shadow-xl p-4">
    <div id="chat" class="space-y-3 mb-4 max-h-[55vh] overflow-y-auto"></div>

    <textarea id="userInput" rows="3"
      placeholder="Ask Pixodra anythingâ€¦"
      class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700"></textarea>

    <div class="flex gap-3 mt-3">
      <button onclick="askPixodra()"
        class="flex-1 bg-white text-black py-2 rounded-xl font-semibold">
        Send
      </button>
      <button onclick="makePDF()"
        class="flex-1 bg-white/15 py-2 rounded-xl">
        Make PDF
      </button>
    </div>
  </div>
</div>

<script>
  let selectedLang = "english";
  let conversation = [];
  let lastUserQuestion = "";

  function setLang(lang){
    selectedLang = lang;
    document.querySelectorAll(".lang-btn").forEach(b=>b.classList.remove("active-lang"));
    document.getElementById(lang).classList.add("active-lang");

    const p = {
      english: "Ask Pixodra anythingâ€¦",
      tamil: "Ungal kelviyai inge type pannungaâ€¦",
      tanglish: "Ungal question-ah inga type pannungaâ€¦"
    };
    userInput.placeholder = p[lang];
  }

  async function askPixodra(){
    const input = userInput.value.trim();
    if(!input) return;

    lastUserQuestion = input;
    chat.innerHTML += `
      <div class="text-right fade-in">
        <div class="inline-block bg-indigo-600/20 px-3 py-2 rounded-xl">${input}</div>
      </div>`;
    userInput.value = "";
    chat.scrollTop = chat.scrollHeight;

    if(input.toLowerCase()==="hi"){
      addBot("Vanakkam ðŸ˜Š Ungalukku enna vendum?");
      return;
    }

    const typing = document.createElement("div");
    typing.innerHTML = `
      <div class="inline-block bg-gray-700/40 px-3 py-2 rounded-xl typing">
        Pixodra typing<span>.</span><span>.</span><span>.</span>
      </div>`;
    chat.appendChild(typing);

    const res = await fetch("/api/ask",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({ message:`[${selectedLang}] ${input}` })
    });
    const data = await res.json();
    typing.remove();
    addBot(data.reply);
    conversation.push(data.reply);
  }

  function addBot(text){
    chat.innerHTML += `
      <div class="fade-in bg-gray-700/50 px-3 py-2 rounded-xl">${text}</div>`;
    chat.scrollTop = chat.scrollHeight;
  }

  /* -------- PDF (GUARANTEED WORKING) -------- */
  function makePDF(){
    if(!conversation.length){
      alert("No content to export");
      return;
    }

    const font = selectedLang === "tamil"
      ? "'Noto Sans Tamil', sans-serif"
      : "serif";

    const date = new Date().toLocaleString();

    const pdfContent = document.createElement("div");
    pdfContent.style.padding = "20mm 15mm 25mm 15mm";
    pdfContent.style.fontFamily = font;
    pdfContent.style.background = "white";
    pdfContent.style.color = "black";
    pdfContent.style.lineHeight = "1.7";

    pdfContent.innerHTML = `
      <div style="font-weight:600; margin-bottom:16px;">
        Question: ${lastUserQuestion} |
        Date: ${date} |
        Language: ${selectedLang.toUpperCase()}
      </div>
      ${conversation.map(m=>`<p>${m}</p>`).join("")}
    `;

    document.body.appendChild(pdfContent);

    html2pdf()
      .set({
        margin: 0,
        html2canvas: { scale: 2 },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
      })
      .from(pdfContent)
      .toPdf()
      .get('pdf')
      .then(pdf => {
        const pageCount = pdf.internal.getNumberOfPages();
        const pageHeight = pdf.internal.pageSize.height;
        const pageWidth = pdf.internal.pageSize.width;

        for (let i = 1; i <= pageCount; i++) {
          pdf.setPage(i);

          // Watermark
          pdf.setFont("Courier", "italic");
          pdf.setFontSize(9);
          pdf.setTextColor(150);
          pdf.text(
            "Thanks for using Pixodra.ai",
            15,
            pageHeight - 10
          );

          // Page number
          pdf.text(
            `Page ${i} of ${pageCount}`,
            pageWidth - 40,
            pageHeight - 10
          );
        }
      })
      .save("pixodra-response.pdf")
      .then(() => pdfContent.remove());
  }
</script>

</body>
</html>
