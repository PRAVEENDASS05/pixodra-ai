<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pixodra.ai</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tamil-safe font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;600&display=swap" rel="stylesheet">

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fade-in { animation: fadeIn 0.3s ease-out; }

    .typing span {
      animation: blink 1.4s infinite both;
    }
    .typing span:nth-child(2){animation-delay:.2s}
    .typing span:nth-child(3){animation-delay:.4s}
    @keyframes blink {
      0%{opacity:.2} 20%{opacity:1} 100%{opacity:.2}
    }

    .lang-btn {
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      transition: .2s;
      font-size: 14px;
      cursor: pointer;
    }
    .active-lang {
      background: rgba(99,102,241,0.35);
      color: #e0e7ff;
      font-weight: 600;
      box-shadow: 0 0 0 2px rgba(99,102,241,0.4);
    }
  </style>
</head>

<body class="bg-gradient-to-br from-slate-900 via-gray-900 to-black min-h-screen text-white">

<div class="max-w-4xl mx-auto p-4">

  <div class="flex justify-between items-center mb-4">
    <h1 class="text-3xl font-bold">PIXODRA.AI</h1>
    <button id="symposiumBtn"
      class="px-4 py-2 rounded-xl bg-indigo-600/20 text-indigo-400">
      ðŸŽ“ Symposium Finder
    </button>
  </div>

  <div class="flex gap-3 mb-4">
    <button id="btnEnglish" class="lang-btn active-lang">English</button>
    <button id="btnTamil" class="lang-btn">Tamil</button>
    <button id="btnTanglish" class="lang-btn">Tanglish</button>
  </div>

  <div class="bg-[#0f172a]/90 rounded-2xl shadow-xl p-4">
    <div id="chatBox" class="space-y-3 mb-4 max-h-[55vh] overflow-y-auto"></div>

    <textarea id="userInput" rows="3"
      class="w-full p-3 rounded-xl bg-gray-800 border border-gray-700"
      placeholder="Ask Pixodra anythingâ€¦"></textarea>

    <div class="flex gap-3 mt-3">
      <button id="sendBtn"
        class="flex-1 bg-white text-black py-2 rounded-xl font-semibold">
        Send
      </button>
      <button id="pdfBtn"
        class="flex-1 bg-white/15 py-2 rounded-xl">
        Make PDF
      </button>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const chatBox = document.getElementById("chatBox");
  const userInput = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const pdfBtn = document.getElementById("pdfBtn");
  const symposiumBtn = document.getElementById("symposiumBtn");

  const btnEnglish = document.getElementById("btnEnglish");
  const btnTamil = document.getElementById("btnTamil");
  const btnTanglish = document.getElementById("btnTanglish");

  let selectedLang = "english";
  let conversation = [];
  let lastUserQuestion = "";

  symposiumBtn.onclick = () => window.location.href = "/symposium";

  function setLang(lang) {
    selectedLang = lang;
    [btnEnglish, btnTamil, btnTanglish].forEach(b => b.classList.remove("active-lang"));
    (lang==="english"?btnEnglish:lang==="tamil"?btnTamil:btnTanglish).classList.add("active-lang");

    userInput.placeholder = {
      english: "Ask Pixodra anythingâ€¦",
      tamil: "Ungal kelviyai inge type pannungaâ€¦",
      tanglish: "Ungal question-ah inga type pannungaâ€¦"
    }[lang];
  }

  btnEnglish.onclick = () => setLang("english");
  btnTamil.onclick = () => setLang("tamil");
  btnTanglish.onclick = () => setLang("tanglish");

  sendBtn.onclick = async () => {
    const input = userInput.value.trim();
    if (!input) return;

    lastUserQuestion = input;

    chatBox.innerHTML += `
      <div class="text-right fade-in">
        <div class="inline-block bg-indigo-600/20 px-3 py-2 rounded-xl">${input}</div>
      </div>`;
    userInput.value = "";
    chatBox.scrollTop = chatBox.scrollHeight;

    if (input.toLowerCase() === "hi") {
      addBot("Vanakkam ðŸ˜Š Ungalukku enna vendum?");
      return;
    }

    const typing = document.createElement("div");
    typing.innerHTML = `
      <div class="inline-block bg-gray-700/40 px-3 py-2 rounded-xl typing">
        Pixodra typing<span>.</span><span>.</span><span>.</span>
      </div>`;
    chatBox.appendChild(typing);

    const res = await fetch("/api/ask", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: \`[\${selectedLang}] \${input}\` })
    });

    const data = await res.json();
    typing.remove();
    addBot(data.reply);
    conversation.push(data.reply);
  };

  function addBot(text) {
    chatBox.innerHTML += `
      <div class="fade-in bg-gray-700/50 px-3 py-2 rounded-xl">${text}</div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  pdfBtn.onclick = () => {
    if (!conversation.length) return alert("No content to export");

    const font = selectedLang === "tamil"
      ? "'Noto Sans Tamil', sans-serif"
      : "serif";

    const pdfDiv = document.createElement("div");
    pdfDiv.style.padding = "20mm 15mm 25mm 15mm";
    pdfDiv.style.fontFamily = font;
    pdfDiv.style.background = "white";
    pdfDiv.style.color = "black";
    pdfDiv.style.lineHeight = "1.7";

    pdfDiv.innerHTML = `
      <div style="font-weight:600; margin-bottom:16px;">
        Question: ${lastUserQuestion} |
        Date: ${new Date().toLocaleString()} |
        Language: ${selectedLang.toUpperCase()} |
        Version: Pixodra-ai (Beta)
      </div>
      ${conversation.map(m => `<p>${m}</p>`).join("")}
    `;

    document.body.appendChild(pdfDiv);

    html2pdf()
      .set({ html2canvas: { scale: 2 } })
      .from(pdfDiv)
      .toPdf()
      .get("pdf")
      .then(pdf => {
        const pages = pdf.internal.getNumberOfPages();
        const h = pdf.internal.pageSize.height;
        const w = pdf.internal.pageSize.width;

        for (let i = 1; i <= pages; i++) {
          pdf.setPage(i);
          pdf.setFont("Courier","italic");
          pdf.setFontSize(10);
          pdf.text("Thanks for using Pixodra.ai", 15, h - 10);
          pdf.text(`Page ${i} of ${pages}`, w - 45, h - 10);
        }
      })
      .save("pixodra-response.pdf")
      .then(() => pdfDiv.remove());
  };

});
</script>

</body>
</html>
